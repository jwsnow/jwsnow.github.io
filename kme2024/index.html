<!doctype html>
<html>
<head><meta name="viewport" content="width=device-width, initial-scale=1">
<title>J.W. Snow</title>
<link rel='stylesheet' type='text/css' href='jws.css'>
<script src='jws.js'></script>

<style>
img.thumb{
	width: 50px;
	height: 50px;
	margin: 10px;
}
img.shotgunimg{
	width: 200px;
	margin: 10px;
}
canvas{
	margin: 20px;
	width: 500px;
}
button.option{
	margin: 10px;
}
div.box{
	display: inline-block;
	border: 1px solid gray;
	margin: 5px;
	margin-left: 20px;
	padding: 5px;
	max-width:500px;
}
#imagebox{
	width: 500px;
}
.hidden{
	display: none;
}

button.colorButton{
	width: 50px;
	height: 50px;
	padding: 0px;
	margin: 5px;
	border: 1px solid gray;
	border-radius: 10px;
	display: inline-block;
}
#drawingcontrols{
	display: none;
	text-align: center;
}
</style>
<script src='spork.js'></script>
<script src='rancomp.js'></script>
<script src='reflection.js'></script>
<script>
 theFunctions=['P1','P2','MUL', 'SINPI', 'COSPI','CUBE','SINXXYY','max','min','SIN2PI','COS2PI','AVG','NOISE'];
 theFunctions=['P1','P2','MUL', 'CUBE','max','min','AVG'];
 theFunctions=['P1','P2','MUL', 'SINPI', 'COSPI','CUBE','SINXXYY','max','min','SIN2PI','COS2PI','AVG','NOISE'];
var theImages=[];
 function preview_image(event) {
    var reader = new FileReader();
    reader.onload = function(){
      var output = document.getElementById('output_image');
      output.src = reader.result;
    }
    reader.readAsDataURL(event.target.files[0]);	
  }
   function preview_image(event) {
    var reader = new FileReader();
    var newimg=document.createElement('img');
    reader.onload = function(){
      newimg.src = reader.result;
      newimg.className='thumb';
      imagebox.appendChild(newimg);
      collectImages();
    }
    reader.readAsDataURL(event.target.files[0]);	
    sourceImage='';
    clear();
  }
  function highlightImage(){
  if (this.src){
	var i;
	for (i=0;i<theImages.length;i++)
		theImages[i].style.border='none';
	this.style.border='5px solid red';
	sourceImage=this;
	drawImage(sourceImage,width/2, height/2, width, height);
}	
  }
  function collectImages(){
	theImages=document.getElementsByClassName('thumb');
	var i;
	for (i=0;i<theImages.length;i++)
		theImages[i].style.border='none';
	for (i=0;i<theImages.length;i++)
		theImages[i].onclick=highlightImage;
  }
  var WIDTH=500;
  var sourceImage='';
var bumpconstant;
  function setup(){
	size(WIDTH, WIDTH);
	collectImages();
//	drawImage(sourceImage,width/2, height/2, width, height);
	RNGSEED=floor(random()*100000000);
	random=RNG;
	nextseed.value=RNGSEED;
//	defaultImage.style.border='5px solid red';
//	sourceImage=defaultImage;
//	drawImage(defaultImage,width/2, height/2, width, height);	
  }
  function realbump(x,y){
	var r=max(0, 1-(pow(x,bumpconstant)+pow(y,bumpconstant)))
	return(r);
}
function onebump(x,y){
	return(1);
}
function bump(x,y){}

  function generateReflection(re){
  if (sourceImage=='') alert('Please select an image.')
  else{
	var r;
	if (re==true){
			nextseed.value=lastseed.value;
	}
	RNGSEED=nextseed.value; console.log(RNGSEED);
	if (bumpit.checked==true){
		bump=realbump;
		bumpconstant=bumpvalueselect.options[bumpvalueselect.selectedIndex].text;
	}
	else {
		bump=onebump;
	}
	if (complexity.checked==true)
		depth=3+floor(random()*5);
	else
		depth=complexityvalueselect.options[complexityvalueselect.selectedIndex].text;
	size(WIDTH, WIDTH);
	getColors(sourceImage);
	background('white');
	if (symmetric.checked==true) r=generateSymmetricImage();
	else r=generateImage();
	lastseed.value=nextseed.value;
	nextseed.value=RNGSEED;
	console.log(r.replaceAll('<br>', '\n'));
}	
  }
function hires(){
	var tw=WIDTH;
	WIDTH=4000;
	generateReflection(true);
	WIDTH=tw;
	alert('High resolution image generated. Save the generated image to your computer to see a larger version.');
}
function shotgun(){
	var i;
	var N=10;
	var u;
	var newimg;
	if (sourceImage=='')
		alert('Please select an image.');
	else{
		for (i=0;i<N;i++){
			u=nextseed.value; //console.log(u);
			generateReflection();
			newimg=document.createElement('img');
			newimg.className='shotgunimg';
			newimg.data_seed=u;
			canvasToImg(newimg);
			newimg.onclick=function(){
				nextseed.value=this.data_seed;
				generateReflection();
				nextseed.value=this.data_seed;
			}
			newimg.title=u;
			scatter.appendChild(newimg);
		}
		newimg=document.createElement('hr');
		scatter.appendChild(newimg);
	}
}
function clearShot(){
	while(scatter.firstChild) 
                scatter.removeChild(scatter.firstChild);
}
  function randomizeSeed(){
	RNGSEED=floor(random()*100000000);
	nextseed.value=RNGSEED;	
  }
  
  //-------------------------------------------------------------
  var strokes=[];
var colors=[];
var widths=[];
var currentStroke=0;
var currentColor;
var currentlySelected;
var currentlySelectedWidth;
var currentWidth=10;
var lastX;
var lastY;
function beginNewStroke(){
	strokes.push([]);
	colors.push(currentColor);
	currentStroke=strokes.length-1;
	widths.push(currentWidth);
	lastX=mouseX;
	lastY=mouseY;
}

var mask=[];
function redraw(){
	clear();
	var i,j;
	for (i=0;i<strokes.length;i++){
		color(colors[i]);
		for (j=0;j<strokes[i].length-1;j++)
			line(strokes[i][j].x, strokes[i][j].y, strokes[i][j+1].x, strokes[i][j+1].y);
	}		
}
function redraw(s){
	background('black');
	var i,j,k;
	var R;
	for (i=0;i<strokes.length;i++){
		color(colors[i]);
		R=widths[i]*s;
		for (j=0;j<strokes[i].length-1;j++)
			for (k=0;k<mask.length;k++)
				line(strokes[i][j].x+R*mask[k].x, strokes[i][j].y+R*mask[k].y, strokes[i][j+1].x+R*mask[k].x, strokes[i][j+1].y+R*mask[k].y);
	}		
}
function stroketo(){
	var k;
	var R=currentWidth;
	color(currentColor);
	for (k=0;k<mask.length;k++)
		line(lastX+R*mask[k].x, lastY+R*mask[k].y, mouseX+R*mask[k].x, mouseY+R*mask[k].y);	
}
function drawingonmousemove(){
	if (mouseDown){
		strokes[currentStroke].push({x: mouseX, y: mouseY});
		//redraw(1);
		stroketo();
		lastX=mouseX;
		lastY=mouseY;
	}
}
function drawingonmousedown(){
	beginNewStroke();
}
function dummy(){}
function undo(){
	strokes.pop();
	colors.pop();
	widths.pop();
	redraw(1);
}
function selectColor(t,c){
	currentColor=c;
	currentlySelected.style.border='1px solid black';
	t.style.border='5px solid gray';
	currentlySelected=t;
	currentlySelectedWidth.style.background=c;
}
function selectWidth(t,c){ 
	currentWidth=c;
	currentlySelectedWidth.style.background='black';
	t.style.background=currentColor;
	currentlySelectedWidth=t;
}
function setupDrawing(){
	currentlySelected=blackButton;
	currentlySelectedWidth=b20;
	currentColor=rgb(66,91,129);
	currentlySelectedWidth.style.background=currentColor;
	currentlySelected.style.border='5px solid gray';
	currentWidth=10;
	color(currentColor);
	var i;
	var a,b;
	for (i=0;i<50;i++){
		a=random()*360;
		b=random()
		mask.push({x: b*COS(a), y: b*SIN(a)});
	}
	//size(400,400);
	background('black');
}

function saveDrawing(){
	var w=width;
	var h=height;
	var s=5;
	size(s*w, s*h);
	var i;
	for (i=0;i<strokes.length;i++)
	for (j=0;j<strokes[i].length;j++){
		strokes[i][j].x*=s;
		strokes[i][j].y*=s;
	}
	linewidth(s);
	redraw(s);
	var newimage=document.createElement('img');
	canvasToImg(newimage);
	newimage.className='thumb';
	imagebox.appendChild(newimage);
	for (i=0;i<strokes.length;i++)
	for (j=0;j<strokes[i].length;j++){
		strokes[i][j].x/=s;
		strokes[i][j].y/=s;
	}	
	size(w,h);
	linewidth(1);
	//size(WIDTH,WIDTH);
	closeDrawing();
}
function closeDrawing(){
	clearDrawing();
	clear();
	currentlySelectedWidth.style.background='black';
	currentlySelected.style.border='1px solid black';
	drawingcontrols.style.display='none';
	onmousedown=dummy;
	onmousemove=dummy;
	collectImages();
}
function clearDrawing(){
	background('black');
	strokes=[];
	colors=[];
	widths=[];	
}

function startDrawing(){
	//size(500,500);
	onmousemove=drawingonmousemove;
	onmousedown=drawingonmousedown;
	setupDrawing();
	clearDrawing();
	drawingcontrols.style.display='inline-block';
}
  //-----------------------------------------------------------
</script>
</head>
<body>
<script>writeHeader();</script>

<div id='spork'></div>


<div id='drawingcontrols'>
<div class='box'>
<div >
<button onclick='selectColor(this,rgb(66,91,129));' id='blackButton' class='colorButton' style='border: 5px solid gray; background: rgb(66,91,129);'>&nbsp;</button>
<button onclick='selectColor(this,rgb(76, 41, 36));' class='colorButton'  style='background: rgb(76, 41, 36);'>&nbsp;</button>
<button onclick='selectColor(this,rgb(108, 64, 57));' class='colorButton'  style='background: rgb(108, 64, 57);'>&nbsp;</button>
<button onclick='selectColor(this,rgb(144, 142, 125));' class='colorButton'  style='background: rgb(144, 142, 125);'>&nbsp;</button>
<button onclick='selectColor(this,rgb(99, 102, 73));' class='colorButton'  style='background: rgb(99, 102, 73);'>&nbsp;</button>
<button onclick='selectColor(this,rgb(78, 69, 63));' class='colorButton'  style='background: rgb(78, 69, 63);'>&nbsp;</button>
<br>
<button onclick='undo();' class='colorButton'>Undo</button>
<button onclick='saveDrawing();' class='colorButton'>Save</button>
<button onclick='clearDrawing();' class='colorButton'>Clear</button>
<button onclick='closeDrawing();' class='colorButton'>Discard</button>
<button onclick='selectWidth(this,10);' class='colorButton'  style='background: rgb(66,91,129); width: 20px;' id='b20'>&nbsp;</button>
<button onclick='selectWidth(this,15);' class='colorButton'  style='background: black; width: 30px;'>&nbsp;</button>
<button onclick='selectWidth(this,20);' class='colorButton'  style='background: black; width: 40px;'>&nbsp;</button>
</div></div></div>


<div><div class='box'>
<button class='option'  onclick='generateReflection()'>Generate with new function.</button class='option' >
<button class='option'  onclick='generateReflection(true)'>Generate with last function.</button class='option' >
</div></div>

<div><div class='box' id='imagebox'>
	<img class='thumb' src='png/JBE.jpg' id='defaultImage'>
	<img class='thumb' src='png/chimayo.jpg'>
	<img class='thumb' src='png/ice.jpg'>
	<img class='thumb' src='png/checker.png'>	
</div></div>
<div><div class='box'>
<button class='option' onclick='startDrawing();'>Draw Something</button>
</div></div>
<div><div class='box'>
<label for='infile'>Load your own image to use as a seed image in generating pictures. After you load the image, be sure to select it above to use it in the algorithm.</label><br>
<input type="file" accept="image/*" onchange="preview_image(event)" id='infile'><br>
</div></div>
<div class='hidden'><div class='box'>
	Next Seed: <input type='text' id='nextseed'><button class='option'  onclick='generateReflection()'>Generate with this seed.</button class='option' ><br>
	The mapping from the canvas to the seed image used to select colors is determined by a unique number. This
	unique number is usually determined randomly, but you can type one in here if you have already determined a mapping you like. Either way, click the button  to generate an image.
</div></div>
<div class='hidden'><div class='box'>
	<label for="complexity"><input type="checkbox" id="complexity" checked=true>  Randomize Complexity </label> or <br> &nbsp; <br> Select Complexity:
	<select id='complexityvalueselect'>
	<option value=3>3</option>
	<option value=4>4</option>
	<option value=5>5</option>
	<option value=6>6</option>
	<option value=7>7</option>
	<option value=8>8</option>
	<option value=9>9</option>
	</select><br>
	<br>
	The complexity is the depth of the parse tree for the reflection functions. Higher complexity means more complicated functions. This may make the image more convoluted, and it may take longer to generate a high resolution image.
</div></div>
<div class='hidden'><div class='box'>
	Last Seed:<input type='text' id='lastseed' disabled='true'><button class='option'  onclick='generateReflection(true)'>Regenerate with this seed.</button class='option' ><br>
	This is the seed that was last used to generate an image. Sometimes, you may want to generate an image using the same
	seed or color mapping after you have changed other options. Use this button  for that.
</div></div>
<div><div class='box'>
	<label for="symmetric"><input type="checkbox" id="symmetric">  Enforce Symmetry </label><br>
	This option will copy one triangle of the generated image 8 times to create a highly symmetric image.  Sometimes, this is
	a good way to turn a meh image into a decent image. Other times, it is simply too cliche.
</div></div>
<div><div class='box'>
	<label for="bumpit"><input type="checkbox" id="bumpit">  Bend away from edge. </label> 
	<select id='bumpvalueselect'>
	<option value=2>2</option>
	<option value=4>4</option>
	<option value=8>8</option>
	<option value=16>16</option>
	</select><br>
	The standard algorithm does not recognize the edges of the canvas, and a pattern can extend off the canvas. This option
	will cause the image to bend away from the edges without an apparent clipping effect. A value of 2 will isolate the image 
	to a circle. Higher values will make the image area closer to a square.
</div></div>
<div class='hidden'><div class='box'>
	<button class='option'  onclick='randomizeSeed();'>Randomize</button class='option' ><br>
	Sometimes, it may seem like the algorithm is stuck in an unimpressive groove. This is merely psychological, but
	if it makes you feel better, you can click this button  to restart the randomization process.
</div></div>
<div><div class='box'>
	<button  class='option'  onclick='shotgun()'>Shotgun</button> <button  class='option'  onclick='clearShot();'>Remove shotgun images</button><br>
	If you are tired of clicking the generate button over and over, you can click the Shotgun button. 
	This will generate several images at a time and add them to the bottom of the page. 
	Click on the one you want, and the seed for that image will be copied to the Next Seed input above.
</div></div>
<div><div class='box'>
<button class='option'  onclick='hires();'>Generate high resolution version of last image generated.</button><br>
Do not do this unless you mean it. This image is slower to generate. Note, the image above will not change size. When the high resolution image is generated, you will receive a notice. When you download the image above, you will receive a larger version.
</div></div>

<div id='scatter'></div>
</script>
</body>
</html>